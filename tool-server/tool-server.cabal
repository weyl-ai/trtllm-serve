cabal-version: 3.0
name:          tool-server
version:       0.1.0
synopsis:      Servant-based tool server with OpenAPI3 for AI agents
description:   
  Code sandbox, attestation, and tool endpoints for AI agents.
  
  Features:
  
    * Workspace management for isolated code editing
    * AST-based search/replace via ast-grep
    * Compilation for Rust, Haskell, Lean, Dhall, PureScript
    * Ed25519 identity and signed attestations
    * Web search and URL reading tools
    * Auto-generated OpenAPI 3.0 spec

license:       MIT
author:        weyl-ai
build-type:    Simple

-- ════════════════════════════════════════════════════════════════════════════════
-- Common settings
-- ════════════════════════════════════════════════════════════════════════════════

common warnings
  ghc-options:
    -Wall
    -Wcompat
    -Widentities
    -Wincomplete-record-updates
    -Wincomplete-uni-patterns
    -Wpartial-fields
    -Wredundant-constraints

common lang
  default-language: GHC2021
  default-extensions:
    DeriveGeneric
    DerivingStrategies
    LambdaCase
    OverloadedStrings
    RecordWildCards
    StrictData

-- ════════════════════════════════════════════════════════════════════════════════
-- Library: Reusable domain logic
-- ════════════════════════════════════════════════════════════════════════════════

library
  import:           warnings, lang
  hs-source-dirs:   lib
  exposed-modules:
    Attestation
    Box
    CAS
    CodeSandbox
  build-depends:
    , aeson             >= 2.0    && < 2.3
    , base              >= 4.14   && < 5
    , bytestring        >= 0.10   && < 0.13
    , containers        >= 0.6    && < 0.8
    , cryptonite        >= 0.29   && < 0.31
    , directory         >= 1.3    && < 1.4
    , filepath          >= 1.4    && < 1.6
    , memory            >= 0.18   && < 0.19
    , process           >= 1.6    && < 1.7
    , stm               >= 2.5    && < 2.6
    , temporary         >= 1.3    && < 1.4
    , text              >= 1.2    && < 2.2
    , time              >= 1.9    && < 1.15

-- ════════════════════════════════════════════════════════════════════════════════
-- Library: API types with OpenAPI3 instances
-- ════════════════════════════════════════════════════════════════════════════════

library api-types
  import:           warnings, lang
  hs-source-dirs:   .
  exposed-modules:
    API
    API.Types
  build-depends:
    , aeson             >= 2.0    && < 2.3
    , base              >= 4.14   && < 5
    , lens              >= 5.0    && < 6
    , openapi3          >= 3.2    && < 3.3
    , servant           >= 0.20   && < 0.21
    , servant-openapi3  >= 2.0    && < 2.1
    , servant-server    >= 0.20   && < 0.21
    , text              >= 1.2    && < 2.2
    , tool-server

-- ════════════════════════════════════════════════════════════════════════════════
-- Executable: Tool server
-- ════════════════════════════════════════════════════════════════════════════════

executable tool-server
  import:           warnings, lang
  main-is:          Server.hs
  hs-source-dirs:   .
  build-depends:
    , aeson             >= 2.0    && < 2.3
    , base              >= 4.14   && < 5
    , base64-bytestring >= 1.2    && < 1.3
    , bytestring        >= 0.10   && < 0.13
    , http-client       >= 0.7    && < 0.8
    , http-client-tls   >= 0.3    && < 0.4
    , lens              >= 5.0    && < 6
    , openapi3          >= 3.2    && < 3.3
    , servant           >= 0.20   && < 0.21
    , servant-openapi3  >= 2.0    && < 2.1
    , servant-server    >= 0.20   && < 0.21
    , text              >= 1.2    && < 2.2
    , tool-server
    , tool-server:api-types
    , warp              >= 3.3    && < 3.5
  ghc-options:
    -threaded
    -rtsopts
    "-with-rtsopts=-N"

-- ════════════════════════════════════════════════════════════════════════════════
-- Test suite
-- ════════════════════════════════════════════════════════════════════════════════

test-suite tool-server-test
  import:           warnings, lang
  type:             exitcode-stdio-1.0
  main-is:          Test.hs
  hs-source-dirs:   test
  build-depends:
    , aeson             >= 2.0    && < 2.3
    , base              >= 4.14   && < 5
    , bytestring        >= 0.10   && < 0.13
    , directory         >= 1.3    && < 1.4
    , hspec             >= 2.10   && < 2.12
    , http-client       >= 0.7    && < 0.8
    , servant-client    >= 0.20   && < 0.21
    , text              >= 1.2    && < 2.2
    , tool-server
  ghc-options:
    -threaded
    -rtsopts
    "-with-rtsopts=-N"

test-suite box-props
  import:           warnings, lang
  type:             exitcode-stdio-1.0
  main-is:          BoxTest.hs
  hs-source-dirs:   test
  build-depends:
    , base              >= 4.14   && < 5
    , hedgehog          >= 1.2    && < 1.5
    , text              >= 1.2    && < 2.2
    , tool-server
  ghc-options:
    -threaded
    -rtsopts
    "-with-rtsopts=-N"
